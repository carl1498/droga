<!DOCTYPE html>
<html lang="en">

<head>
	<title>DESCRY</title>
	<link href="https://fonts.googleapis.com/css?family=Nunito:400,600,700" rel="stylesheet">
	<link rel="stylesheet" href="../assets/css/style.css" />
	<meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <!-- Favicons -->
    <link rel="apple-touch-icon" href="../assets/img/pills.png">
    <link rel="icon" href="../assets/img/pills.png">
    <!--     Fonts and icons     -->
    <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:400,700|Material+Icons" />
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/latest/css/font-awesome.min.css" />
    <link rel="stylesheet" href="../assets/css/material-dashboard.css?v=2.0.0">
    <!-- Documentation extras -->
    <!-- CSS Just for demo purpose, don't include it in your project -->
    <link href="../assets/assets-for-demo/demo.css" rel="stylesheet" />
    <!-- iframe removal -->
</head>
<style type="text/css">
html, body{
	background: #17202A;
	min-height: 100%;
}

body{
  	position: absolute;
}

h2, h3,p{
	margin:0; padding:0;
	color: white;
	font-family: 'Nunito', sans-serif;
}

.login {
	margin:0 auto;
	max-width:500px;
}

.login-header {
	color:#fff;
	text-align:center;
	font-size:300%;
}

/* .login-header h1 {
   text-shadow: 0px 5px 15px #000; 
}

.login-form {
  border:.5px solid #fff;
  background:#4facff;
  border-radius:10px;
  box-shadow:0px 0px 10px #000;
}*/

.login-form h3 {
	text-align:left;
	margin-left:40px;
	color:#fff;
}

.login-form {
	box-sizing:border-box;
	padding-top:15px;
	padding-bottom:10%;
	margin:5% auto;
	text-align:center;
}

.login input[type="email"],
.login input[type="password"] {
	max-width:400px;
	width: 80%;
	line-height:3em;
	font-family: 'Nunito', sans-serif;
	margin:1em 2em;
	border-radius:5px;
	border:2px solid #f2f2f2;
	outline:none;
	padding-left:10px;
}

.login-form button[type="submit"] {
	height:30px;
	width:100px;
	background:#fff;
	border:1px solid #f2f2f2;
	border-radius:20px;
	color: slategrey;
	text-transform:uppercase;
	font-family: 'Nunito', sans-serif;
	cursor:pointer;
}

.sign-up{
	color:#f2f2f2;
	margin-left:-70%;
	cursor:pointer;
	text-decoration:underline;
}

.no-access {
	color:#E86850;
	margin:20px 0px 20px -57%;
	text-decoration:underline;
	cursor:pointer;
}

.try-again {
	color:#f2f2f2;
	text-decoration:underline;
	cursor:pointer;
}

/*Media Querie*/
@media only screen and (min-width : 150px) and (max-width : 530px){
	.login-form h3 {
		text-align:center;
		margin:0;
	}
	.sign-up, .no-access {
		margin:10px 0;
	}
	.login-button {
		margin-bottom:10px;
	}
}
 

@keyframes spin {
	0% { transform: rotate(0deg); }
	100% { transform: rotate(360deg); }
}
#menu {
        z-index: 1;
        margin-top: 65px;
        margin-left: 35px;
        position: relative;
        padding: 10px;
        font-family: 'Open Sans', sans-serif;
    }
    #map { position:absolute; top:0; bottom:0; 
      z-index:0}
      .popup {
  text-align:center;
  }
.popup .slideshow .image        { display:none; }
.popup .slideshow .image.active { display:block; }
.popup .slideshow img {
  width:100%;
  }
.popup .slideshow .caption {
  background:#eee;
  padding:10px;
  }
.popup .cycle {
  padding:10px 0 20px;
  }
  .popup .cycle a.prev { float:left; }
  .popup .cycle a.next { float:right; }
</style>

<body class="wrapper">      
    <div class="body">
		<div id="login_div" class="login">
			<div class="modal fade" id="loader_modal" tabindex="-1" role="dialog">
				<div class="modal-dialog modal-lg" role="document">
					<div class="row">
						<div class="loader">log in</div>             
					</div>
				</div>
			</div>
    
			<div>
				<br><br><br><br>
				<h2 align="center">DES<img src="../assets/img/pills.png" height="80" width="80">CRY</h2>
			</div>
			<h3 align="center">LOGIN</h3>
			<form id="login" class="login-form">
				<input type="email" placeholder="Email..." id="email_field" />
				<input type="password" placeholder="Password..." id="password_field" />

				<button type="submit">Login</button><br>
				<button type="button" id="create_account" class="btn bootstrap-notify">Create New Account</button>
			</form>
		</div>

 		<div id="verification" class="login">
			<div class="modal fade" id="loader_modal" tabindex="-1" role="dialog">
				<div class="modal-dialog modal-lg" role="document">
					<div class="row">
						<div class="loader" >Verifying..</div>             
					</div>
				</div>
			</div>
       
    		<div>
      			<br><br><br><br>
               <h2 align="center">DES<img src="../assets/img/pills.png" height="80" width="80">CRY</h2>
            </div>
			<h3 align="center">Verification</h3>
			<div align="center">
				<button type="button" id="verify"  class="btn bootstrap-notify">Verify Account!</button>
			</div>
    		<a class="nav-link" href="" id="back">
				<i class="material-icons">reply</i>
				<p>Back</p>
			</a>
  		</div>
  	</div>

  	<div id="user_div">
    	<div class="wrapper">
        	<div class="sidebar" data-color="azure" data-background-color="white" style="background-color: #212F3C;" data-image="../assets/img/sidebar-1.jpg">
           		<div class="logo"  align="center">
            		<h2> DES<img src="../assets/img/pills.png" height="70" width="70">CRY</h2>
				</div>
				
            	<div class="sidebar-wrapper">
					<ul class="nav">
						<li class="nav-item">
							<a class="nav-link" href="../pages">
								<i class="material-icons">dashboard</i>
								<p>Dashboard</p>
							</a>
						</li>
						<li class="nav-item ">
							<a class="nav-link" href="../pages/drugs_table.html">
								<i class="material-icons">content_paste</i>
								<p>DATASETS</p>
							</a>
						</li>
						<li class="nav-item active  ">
							<a class="nav-link" href="../pages/maps.html">
								<i class="material-icons">location_ons</i>
								<p>Maps</p>
							</a>
						</li>
						<li class="nav-item">
							<a class="nav-link" href="" id="logout">
								<i class="material-icons">reply</i>
								<p>Logout</p>
							</a>
						</li>
					</ul>
            	</div>
        	</div>
			
			<div class="main-panel">
            	<!-- Navbar -->
				<nav class="navbar navbar-expand-lg navbar-transparent  navbar-absolute fixed-top">
					<div class="container-fluid">
						<div class="navbar-wrapper">
							<a class="navbar-brand" style="color: white;">Maps</a>
						</div>
						<button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navigation" aria-controls="navigation-index" aria-expanded="false" aria-label="Toggle navigation">
							<span class="sr-only">Toggle navigation</span>
							<span class="navbar-toggler-icon icon-bar"></span>
							<span class="navbar-toggler-icon icon-bar"></span>
							<span class="navbar-toggler-icon icon-bar"></span>
						</button>
						
					</div>
				</nav>
            	<!-- End Navbar -->
              <div id="allview">
             
            	<div id="map"></div>
            
             <div id='menu'>
                <input id='basic' type='radio' name='rtoggle' value='dark' checked='checked'>
                <label for='basic'>Dark</label>
                <input id='streets' type='radio' name='rtoggle' value='streets'>
                <label for='streets'>Streets</label>
                <input id='light' type='radio' name='rtoggle' value='streets-satellite'>
                <label for='light'>SS</label>
                <input id='dark' type='radio' name='rtoggle' value='light'>
                <label for='dark'>Light</label>
                <input id='satellite' type='radio' name='rtoggle' value='satellite'>
                <label for='satellite'>S</label>
              </div>
              </div>
        	</div>
    	</div>
	</div>
</body>

<script src='https://api.mapbox.com/mapbox.js/v3.0.1/mapbox.js'></script>
<link href='https://api.mapbox.com/mapbox.js/v3.0.1/mapbox.css' rel='stylesheet' />
<script src='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v2.2.0/mapbox-gl-geocoder.min.js'></script>
<link rel='stylesheet' href='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v2.2.0/mapbox-gl-geocoder.css' type='text/css' />
<script src='https://api.mapbox.com/mapbox.js/plugins/leaflet-fullscreen/v1.0.1/Leaflet.fullscreen.min.js'></script>
<link href='https://api.mapbox.com/mapbox.js/plugins/leaflet-fullscreen/v1.0.1/leaflet.fullscreen.css' rel='stylesheet' />
<!--   Core JS Files   -->
<script src="../assets/js/core/jquery.min.js"></script>
<script src="../assets/js/core/popper.min.js"></script>
<script src="../assets/js/bootstrap-material-design.js"></script>
<script src="../assets/js/plugins/perfect-scrollbar.jquery.min.js"></script>
<!-- Google Map Plugin -->
<script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCI3Uo3Zc3LdKB_vrJNfqxhgSizm2XG7zc"></script>
<script src="../assets/js/plugins/demo.js"></script>
<script src="https://www.gstatic.com/firebasejs/4.13.0/firebase.js"></script>
<script type="text/javascript">
	document.getElementById("login_div").style.display = "none";
	document.getElementById("user_div").style.display = "none";
	document.getElementById("verification").style.display = "none";
 
	var config = {
		apiKey: "AIzaSyDUjaNAD6BhgCQCf1WqKvhBE_iV5bGlZ44",
		authDomain: "descry-9b0ce.firebaseapp.com",
		databaseURL: "https://descry-9b0ce.firebaseio.com",
		projectId: "descry-9b0ce",
		storageBucket: "",
		messagingSenderId: "465099358873"
	};
	firebase.initializeApp(config);

	firebase.auth().onAuthStateChanged(function(user) {
    var mapview;
    var mapSimple;
		if (user) {
			var user = firebase.auth().currentUser;
			var email_id = user.email;
			var email_verified =user.emailVerified;
			$('#loader_modal').modal('hide');
     
    		// User is signed in.
          	if(email_verified==false){
				$('#loader_modal').modal('hide');
				document.getElementById("user_div").style.display = "none";
				document.getElementById("login_div").style.display = "none";
				document.getElementById("verification").style.display = "block";
          	}else{
				$('#loader_modal').modal('hide');

				$('#loader_modal').on('hidden.bs.modal', function (e) {
      				LoadOnce();
     			});
				document.getElementById("user_div").style.display = "block";
				document.getElementById("login_div").style.display = "none";
				document.getElementById("verification").style.display = "none";
          	}
  		}
		else{
			$('#loader_modal').modal('hide');
			document.getElementById("user_div").style.display = "none";
			document.getElementById("login_div").style.display = "block";
			document.getElementById("verification").style.display = "none";
  		}

  		$(document).ready(function() {
        mapview = "dark"
       switchLayer();
        $('input:radio[name="rtoggle"]').change(function() {
        mapview =$(this).val(); 
         switchLayer();
    });
			$("#login").on('submit',function(event){
				$('#loader_modal').modal('show');
				event.preventDefault();
				//alert();
				var userEmail = document.getElementById("email_field").value;
				var userPass = document.getElementById("password_field").value;

				firebase.auth().signInWithEmailAndPassword(userEmail, userPass).catch(function(error) {
					// Handle Errors here.
					var errorCode = error.code;
					var errorMessage = error.message;
					window.alert("Error : " + errorMessage);
				});
			});

      		$("#create_account").on('click',function(event){
				$('#loader_modal').modal('show');
				event.preventDefault();
				var userEmail = document.getElementById("email_field").value;
				var userPass = document.getElementById("password_field").value;

              	firebase.auth().createUserWithEmailAndPassword(userEmail, userPass).catch(function(error) {
					// Handle Errors here.
					var errorCode = error.code;
					var errorMessage = error.message;
					window.alert("Error : " + errorMessage);
             	});
        	});

			$("#verify").on('click',function(event){                
				event.preventDefault();
				var user = firebase.auth().currentUser;
				user.sendEmailVerification().then(function() {
					window.alert("Verification Sent!");
				}).catch(function(error) {
					window.alert("Error: "+ error.message);
				});
			});

     		$("#logout").click(function(event){
				firebase.auth().signOut().then(function() {
					var address = window.location.origin;
					window.location= address+"/pages";
				}, function(error) {
					alert();
				});
     		});

			$("#back").click(function(event){
				firebase.auth().signOut().then(function() {
					var address = window.location.origin;
					window.location= address+"/pages";
				}, function(error) {
					alert();
				});
			});

      
       
  function switchLayer(layer) {
    if(mapSimple!=null){
      mapremove();
      addElement();
    }

       
				L.mapbox.accessToken = 'pk.eyJ1IjoiZHJ1Z2Rlc2NyeSIsImEiOiJjamg0Y256ZHMwbjJxMnpvMm84aWpmb3dmIn0.evfUh1Swt1ChxQCFFUU3mg';
          
               mapSimple = L.mapbox.map('map','mapbox.'+mapview,{
                fullscreenControl: true,
                fullscreenControl: {
                    pseudoFullscreen: false 
               }},).setView([7.1907, 125.4553], 9);

               var mapLayer = L.mapbox.featureLayer().addTo(mapSimple);
                var databaseRef = firebase.database().ref('reports');
				var rowIndex = 1;
				var street='';
				var place='';
				var city='';
				var country='';
				var geojson;
				databaseRef.on('value', function(snapshot) {
                    snapshot.forEach(function(childSnapshot) {
						var childKey = childSnapshot.key;
						var childData = childSnapshot.val();
						$.ajax({url: "https://www.mapquestapi.com/geocoding/v1/reverse?key=GjXdAfoF0XL1JdpVSEAP34B2YAIEvRno&location="+childData.latitude+","+childData.longitude+"&includeRoadMetadata=true&includeNearestIntersection=true", success: function(result){
							street = result.results[0].locations[0].street;
							place = result.results[0].locations[0].adminArea5;
							city = result.results[0].locations[0].adminArea3;
							country = result.results[0].locations[0].adminArea1;
							geojson = [{
								type: 'Feature',
								geometry: {
									type: 'Point',
									coordinates: [childData.longitude, childData.latitude]
									
								},
								properties: {
									'marker-color': '#FF0000',
									'marker-symbol': 'camera',
									description: '<strong>Location:</strong> '+ street+', '+place+', '+city+', '+country+'.'+
									'<br><strong>Drug: </strong>'+childData.drugName+'<br><strong>Reported By: </strong>'+childData.email,
										image: childData.url,
									// icon: {
								 //       iconUrl: 'https://www.mapbox.com/mapbox.js/assets/images/astronaut2.png',
								 //       iconSize: [50, 50], // size of the icon
								 //        iconAnchor: [25, 25], // point of the icon which will correspond to marker's location
								 //        popupAnchor: [0, -25], // point from which the popup should open relative to the iconAnchor
								 //        className: 'dot'
								 //      }
                            	}
                          	}];
                          	

                      		var myLayer = L.mapbox.featureLayer().setGeoJSON(geojson).addTo(mapSimple);
                      		 console.log(myLayer._geojson[0]);
                      		  var content ='<div "class="popup">' +
				                            '<p style="color:black;font-size:12px;" >' + myLayer._geojson[0].properties.description + '</p>' +
				                            '<div class="image" align="center">' +
				                                '<img src="'+myLayer._geojson[0].properties.image+'" style="height: 200px; width:200px" align="center">'+ 
				                            '</div>' +
				                        '</div>';
				                         
							 myLayer.setGeoJSON(geojson);
							 myLayer.bindPopup(content);
							 
                      	}});

                   		rowIndex = rowIndex + 1;
                   	

                    });
                    	
				         	          
     //                mapLayer.on('layeradd', function(e) {
					// console.log(e.layer);
					//   var marker = e.layer,
					//     feature = marker.feature;
					//  // marker.setIcon(L.icon(feature.properties.icon));
					//   var content ='<div "class="popup">' +
				 //                            '<p style="color:black;font-size:12px;" >' + feature.properties.description + '</p>' +
				 //                            '<div class="image" align="center">' +
				 //                                '<img src="'+feature.properties.image+'" style="height: 200px; width:200px" align="center">'+ 
				 //                            '</div>' +
				 //                        '</div>';
					//   marker.bindPopup(content);
					//   });
				});
				
				// mapSimple.on('layeradd', function(e) {
				//     var marker = e.layer;
				//     var feature = marker.feature;
				//     var images = feature.properties.images
				//     var slideshowContent = '';

				//     for(var i = 0; i < images.length; i++) {
				//         var img = images[i];

				//         slideshowContent += '<div class="image' + (i === 0 ? ' active' : '') + '">' +
				//                               '<img src="' + img[0] + '" />' +
				//                               '<div class="caption">' + img[1] + '</div>' +
				//                             '</div>';
				//     }

				//     // Create custom popup content
				//     var popupContent =  '<div id="' + feature.properties.id + '" class="popup">' +
				//                             '<h2>' + feature.properties.title + '</h2>' +
				//                             '<div class="slideshow">' +
				//                                 slideshowContent +
				//                             '</div>' +
				                             
				//                         '</div>';

				//     // http://leafletjs.com/reference.html#popup
				//     marker.bindPopup(popupContent,{
				//         closeButton: false,
				//         minWidth: 320
				//     });
				// });
			//	mapSimple.setGeoJSON(geoJson);

					// $('#map').on('click', '.popup .cycle a', function() {
					//     var $slideshow = $('.slideshow'),
					//         $newSlide;

					//     if ($(this).hasClass('prev')) {
					//         $newSlide = $slideshow.find('.active').prev();
					//         if ($newSlide.index() < 0) {
					//             $newSlide = $('.image').last();
					//         }
					//     } else {
					//         $newSlide = $slideshow.find('.active').next();
					//         if ($newSlide.index() < 0) {
					//             $newSlide = $('.image').first();
					//         }
					//     }

					//     $slideshow.find('.active').removeClass('active').hide();
					//     $newSlide.addClass('active').show();
					//     return false;
					// });


                // set multiple marker
                // for (var i = 0; i < 250; i++) {}
                //   for (var i = 0; i < inputs.length; i++) {
                //         inputs[i].onclick = switchLayer;
                //     }
      }
		});

		function LoadOnce(){ 
			window.location.reload(); 
		} 

      function mapremove(){ 
     map.remove();
    } 
    function addElement() {
    var div = document.createElement('div');
    div.id='map';
      
    document.getElementById('allview').appendChild(div);
}


//     function switchLayer(layer) {
//       //alert();
//     var layerId = layer.target.id;
//   // mapSimple.setStyle('mapbox://styles/mapbox/' + layerId + '-v9');
//   L.mapbox.featureLayer().setStyle('mapbox://styles/mapbox/' + layerId + '-v9').addTo(mapSimple);
// }




		// function geocodeLatLng(geocoder, map, infowindow) {	
		// 	var input = document.getElementById('latlng').value;
		// 	var latlngStr = input.split(',', 2);
		// 	var latlng = {lat: parseFloat(latlngStr[0]), lng: parseFloat(latlngStr[1])};
		// 	console.log(latlng);
		// 	geocoder.geocode({'location': latlng}, function(results, status) {
		// 		if (status === 'OK') {
		// 			if (results[0]) {
		// 				map.setZoom(11);
		// 				var marker = new google.maps.Marker({
		// 					position: latlng,
		// 					map: map
		// 				});
		// 				infowindow.setContent(results[0].formatted_address);
		// 				infowindow.open(map, marker);
  //     				}
		// 			else{
  //       				window.alert('No results found');
  //     				}
		// 		}
		// 		else{
  //     				window.alert('Geocoder failed due to: ' + status);
  //   			}
  // 			});
		// }
	});
</script>

<!--  Charts Plugin, full documentation here: https://gionkunz.github.io/chartist-js/ -->
<script src="../assets/js/plugins/chartist.min.js"></script>
<!-- Library for adding dinamically elements -->
<script src="../assets/js/plugins/arrive.min.js" type="text/javascript"></script>
<!--  Notifications Plugin, full documentation here: http://bootstrap-notify.remabledesigns.com/    -->
<script src="../assets/js/plugins/bootstrap-notify.js"></script>
<!-- Material Dashboard Core initialisations of plugins and Bootstrap Material Design Library -->
<script src="../assets/js/material-dashboard.js?v=2.0.0"></script>
<!-- demo init -->
</html>
